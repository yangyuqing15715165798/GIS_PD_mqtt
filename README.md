# GIS局部放电在线监测系统

这是一个基于MQTT协议的GIS（气体绝缘开关设备）局部放电在线监测系统，使用PySide6构建GUI界面，并通过matplotlib实现数据可视化。

## 功能特点

- 通过MQTT协议实时接收局部放电数据
- 支持多种图表显示方式（散点图、线图）
- 左右双图布局：左侧PRPD图，右侧PRPS三维图
- 可调整数据缓冲区大小
- 实时显示连接状态和数据点数量
- 美观的用户界面
- 多线程处理MQTT通信，避免主线程阻塞
- 消息队列缓冲机制，提高数据处理效率
- 优化的图表绘制策略，减少UI卡顿
- 线程安全的数据访问机制
- 支持数据周期累积显示，可自定义累积周期数

![image](https://github.com/user-attachments/assets/f33521ad-5467-4829-aa53-b996937ea39c)
![image](https://github.com/user-attachments/assets/9fc7e4f3-171f-4c80-a2cf-5e00924b5e8e)
![image](https://github.com/user-attachments/assets/85fb6f8b-361a-4034-bf7b-42ab2f0c81a1)
![image](https://github.com/user-attachments/assets/f5f4825c-2db6-4528-8b26-ada3042e43c5)
![image](https://github.com/user-attachments/assets/d7929378-b7e0-4e13-87f0-7080a933a0d3)



## 技术实现

- **PySide6**: 用于构建现代化GUI界面
- **MQTT**: 使用paho-mqtt库实现MQTT通信
- **Matplotlib**: 用于数据可视化，支持多种图表类型
- **Matplotlib 3D**: 使用mplot3d工具包实现三维PRPS图
- **多线程**: 使用QThread处理MQTT通信，避免阻塞主线程
- **消息队列**: 使用Python的queue模块实现消息缓冲
- **互斥锁**: 使用QMutex保证线程安全
- **定时器**: 使用QTimer控制UI更新频率

## 数据可视化

系统提供两种互补的数据可视化方式：

1. **PRPD图** (相位分辨局部放电图)：
   - 二维散点图或线图
   - X轴表示相位(0~360°)
   - Y轴表示放电幅值
   - 可累积多个周期数据

2. **PRPS图** (相位分辨脉冲序列图)：
   - 三维表面图
   - X轴表示相位(0~360°)
   - Y轴表示周期序号
   - Z轴表示放电幅值
   - 默认显示最新的50个周期数据
   - 使用颜色映射增强数据可视化效果

用户可以通过界面选项切换是否显示PRPS三维图。

## 数据处理流程

系统采用多级缓冲和定时更新机制处理数据：

1. **MQTT消息接收**：
   - MQTT消息在独立线程中接收，避免阻塞主线程
   - 接收到的原始十六进制数据经过解析和转换

2. **消息队列缓冲**：
   - 处理后的数据放入消息队列，而不是直接更新UI
   - 队列大小限制为10条消息，避免内存溢出
   - 如果队列已满，新消息将被丢弃，保证系统稳定性

3. **数据更新频率**：
   - 消息队列处理频率：每50毫秒处理一次队列中的数据
   - 图表重绘频率：每200毫秒重绘一次图表（相当于每秒5次更新）
   - 状态信息更新：每1000毫秒（1秒）更新一次状态信息

4. **数据周期累积**：
   - 每收到一次完整数据视为一个周期
   - 系统可累积多个周期的数据进行显示（默认50个周期）
   - 用户可通过界面设置累积的周期数
   - 当累积周期数达到设定值后，新数据会替换最早的周期数据
   - PRPS三维图始终显示最新的周期数据

5. **数据流向**：
   ```
   MQTT消息 → 消息队列 → 数据周期累积 → 图表显示(PRPD+PRPS)
   ```

6. **线程安全**：
   - 使用互斥锁保护数据缓冲区的读写操作
   - 图表绘制前复制数据，避免在绘制过程中数据被修改

这种设计确保了系统在高频率数据流下仍能保持流畅运行，同时提供近乎实时的数据可视化。

## 性能优化

- 使用独立线程处理MQTT消息，避免主线程阻塞
- 实现消息队列缓冲机制，控制数据处理频率
- 分离数据更新和图表绘制逻辑，提高UI响应性
- 优化matplotlib绘图参数，提高绘图效率
- 使用互斥锁保护共享数据，确保线程安全
- 对于三维图，采用数据重采样策略，确保不同周期数据点数一致

减轻主线程负担：MQTT消息处理在单独的线程中进行
控制更新频率：不再每收到消息就更新图表，而是以固定频率更新
避免数据竞争：使用互斥锁保护共享数据

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

1. 运行程序：

```bash
python gis_pd_mqtt_gui.py
```

2. 在界面中设置MQTT Broker的地址、端口和主题
3. 点击"连接"按钮连接到MQTT服务器
4. 连接成功后，系统将自动接收数据并绘制PRPD和PRPS图
5. 可以通过下拉菜单选择PRPD图的类型（散点图、线图）
6. 可以调整数据缓冲区大小，控制显示的数据点数量
7. 可以使用"显示PRPS三维图"选项切换是否显示三维图
8. 设置"累积周期数"可以控制显示多少次接收到的数据
9. 使用"清除数据"按钮可以重置图表
10. 使用"重置周期"按钮可以清除已累积的周期数据，重新开始累积

## 数据格式

系统接收十六进制格式的数据，每4个字符解析为一个16进制数，并按以下公式转换：
- 转换值 = 十进制值 * 3.3 / 4096

## 系统要求

- Python 3.6+
- PySide6
- paho-mqtt
- matplotlib (含mplot3d)
- numpy

## 代码架构

系统由以下几个主要类组成：

- **MplCanvas**: Matplotlib画布类，用于在Qt界面中嵌入matplotlib图形，支持2D和3D子图
- **MQTTThread**: MQTT处理线程，避免阻塞主线程
- **MQTTClient**: MQTT客户端类，处理MQTT连接和消息接收
- **MainWindow**: 主窗口类，管理GUI和业务逻辑 
